name: Discord Summary

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_SUMMARY_WEBHOOK }}
        run: |
          # Extract commit info
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_BODY=$(echo '${{ github.event.head_commit.message }}' | tail -n +3 | head -20)
          AUTHOR="${{ github.event.head_commit.author.name }}"
          REPO="${{ github.repository }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          # Check if it's a Claude Code commit
          IS_CLAUDE="false"
          if echo '${{ github.event.head_commit.message }}' | grep -q "Claude Code"; then
            IS_CLAUDE="true"
          fi

          # Build embed
          if [ "$IS_CLAUDE" = "true" ]; then
            COLOR=10181046  # Purple for Claude commits
            FOOTER="ðŸ¤– AI-Assisted Development"
          else
            COLOR=3066993   # Green for manual commits
            FOOTER="ðŸ‘¤ Manual Commit"
          fi

          # Create JSON payload with proper escaping
          JSON_PAYLOAD=$(jq -n \
            --arg title "ðŸ“¦ ${REPO##*/} - New Commit" \
            --arg desc "**${COMMIT_MSG}**

${COMMIT_BODY}" \
            --argjson color "${COLOR}" \
            --arg author "${AUTHOR}" \
            --arg sha "[${SHORT_SHA}](${COMMIT_URL})" \
            --arg footer "${FOOTER}" \
            --arg timestamp "${{ github.event.head_commit.timestamp }}" \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                fields: [
                  {
                    name: "Author",
                    value: $author,
                    inline: true
                  },
                  {
                    name: "Commit",
                    value: $sha,
                    inline: true
                  }
                ],
                footer: {
                  text: $footer
                },
                timestamp: $timestamp
              }]
            }')

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK"